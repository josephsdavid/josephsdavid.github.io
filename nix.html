<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="David Josephs" />

<meta name="date" content="2019-12-07" />

<title>Building a Reproducible Data Science Environment with Nix</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/darkly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />
<link href="site_libs/ionicons-2.0.1/css/ionicons.min.css" rel="stylesheet" />


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #ffffff;
    color: #a0a0a0;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #a0a0a0;  padding-left: 4px; }
div.sourceCode
  { color: #1f1c1b; background-color: #ffffff; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span. { color: #1f1c1b; } /* Normal */
code span.al { color: #bf0303; background-color: #f7e6e6; font-weight: bold; } /* Alert */
code span.an { color: #ca60ca; } /* Annotation */
code span.at { color: #0057ae; } /* Attribute */
code span.bn { color: #b08000; } /* BaseN */
code span.bu { color: #644a9b; font-weight: bold; } /* BuiltIn */
code span.cf { color: #1f1c1b; font-weight: bold; } /* ControlFlow */
code span.ch { color: #924c9d; } /* Char */
code span.cn { color: #aa5500; } /* Constant */
code span.co { color: #898887; } /* Comment */
code span.cv { color: #0095ff; } /* CommentVar */
code span.do { color: #607880; } /* Documentation */
code span.dt { color: #0057ae; } /* DataType */
code span.dv { color: #b08000; } /* DecVal */
code span.er { color: #bf0303; text-decoration: underline; } /* Error */
code span.ex { color: #0095ff; font-weight: bold; } /* Extension */
code span.fl { color: #b08000; } /* Float */
code span.fu { color: #644a9b; } /* Function */
code span.im { color: #ff5500; } /* Import */
code span.in { color: #b08000; } /* Information */
code span.kw { color: #1f1c1b; font-weight: bold; } /* Keyword */
code span.op { color: #1f1c1b; } /* Operator */
code span.ot { color: #006e28; } /* Other */
code span.pp { color: #006e28; } /* Preprocessor */
code span.re { color: #0057ae; background-color: #e0e9f8; } /* RegionMarker */
code span.sc { color: #3daee9; } /* SpecialChar */
code span.ss { color: #ff5500; } /* SpecialString */
code span.st { color: #bf0303; } /* String */
code span.va { color: #0057ae; } /* Variable */
code span.vs { color: #bf0303; } /* VerbatimString */
code span.wa { color: #bf0303; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">David Does Data</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Nix
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="nix.html">Nix for Data Science 1</a>
    </li>
    <li>
      <a href="advancedNix.html">Nox for Data Science 2: COMING SOON</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    IML
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="iml.html">Interpretable Machine Learning: Part 1 COMING SOON</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Time Series
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="tsEDA.html">Time Series EDA</a>
    </li>
    <li>
      <a href="tspreprocessing.html">Time Series Cleaning</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/josephsdavid">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="https://twitter.com/Daved256">
    <span class="ion ion-social-twitter"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Building a Reproducible Data Science Environment with Nix</h1>
<h4 class="author">David Josephs</h4>
<h4 class="date">2019-12-07</h4>

</div>


<p><a href="DSblog.html">Back to Navigation</a></p>
<p><a href="advancedNix.html">Part 1.5</a></p>
<div id="why-nix" class="section level1">
<h1>Why Nix?</h1>
<p>Data science environments are a massive headache. We depend on lots of <em>languages</em>, including python, R, sometimes javascript, and many more. We also depend on lots of <em>packages</em> within each language, some of which have dependencies outside of the language, for example if we are using tensorflow or pytorch with CUDA, or almost any fast R package. This creates for each project more or less a complex web of dependencies, to the point where our entire project, or any old project, can be more or less ruined by a simple update, or some issue when we install a new package. This is especially true in Python.</p>
<p>Luckily for Python users everywhere, we have some workarounds. We can use conda, which resolves dependencies itself, but is very difficult to rollback and oftentimes mysterious and frustrating. We can also develop an elaborate setup with pipenv or virtualenv and pip or whatever, but what about dependencies outside of python? How do we intend to deploy our model?</p>
<p>Enter <a href="https://nixos.org/nix/">nix</a>. Nix is a 100% reproducible package manager, for all languages and all things. This means your python environment, your R environment, your models, your <strong><em>entire computer</em></strong> can be completely reproduced, all using the magic of nix. In this article, we will walk through setting up a simple, reproducible, and failproof data science stack with nix, including importing packages not found on nixpkgs and caching the builds online</p>
<div id="how-does-nix-work" class="section level2">
<h2>How does Nix work?</h2>
<p>Let us first think about how an environment is managed on a normal system. For that, the easiest way to think of it is to imagine a cobweb</p>
<div class="figure">
<img src="cobweb.jpeg" alt="" />
<p class="caption">/usr/bin…</p>
</div>
<p>Each time you add a new package to your environment, it goes into /usr/bin or somewhere similar, and connects itself to all the other packages it depends on and the ones which may depend on it, through a crazy web of symlinks and fresh hell. You are adding another connected node to the cobweb.</p>
<p>Now, try updating your computer, or working on a project that needs an older version of one of these dependencies. Suddenly, you are applying a force to the cobweb, moving nodes around. Unsurprisingly, this breaks the cobweb, and <strong><em>nothing</em></strong> works anymore.</p>
<p>Now, lets discuss how nix does it. Instead of /usr/bin, or whatever, a package managed by nix goes in /nix/store, named by a cryptographic hash for that specific version of that package. So this means that for example python 3.7 is stored in /nix/store/someverylongandcomplexhash-python37, while python 3.6 is stored in /nix/store/someotherlongcomplexhash-python36. Within these directories, the dependencies are stored for each package. So instead of a densely connected node in a cobweb, we can visualize each package as a tree in a forest.</p>
<div class="figure">
<img src="forest.jpg" alt="" />
<p class="caption">/nix/store :)</p>
</div>
<p>Each tree minds its own business, and has its own roots, branches and leaves. If one tree moves or falls down or anyting like that, it does not affect the other trees. This is the same as /nix/store. Similarly, if we were to “update” our system, none of the old trees would die. Instead, new trees would grow, still separate from the old trees. This means that A) it is literally impossible to enter dependency hell, or break packages by changing other packages, and B) we can work with multiple versions of the same package.</p>
<p>Let us now, for the purposes of data science, ask a question. Can I represent my environment <strong><em>for a single project</em></strong> as a package? Of course!!!! We can <em>easily</em> wrap up our entire data science environment as a completely isolated tree in our forest of packages. This means we can work on one project without any fear of it messing up our other projects, or anything on our computer!!</p>
</div>
</div>
<div id="making-a-reproducible-isolated-environment" class="section level1">
<h1>Making a reproducible, isolated environment</h1>
<p>First, I will show the code used to make a solid working environment, and then we will walk through it line by line. Name this file <code>shell.nix</code></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="bu">let</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>  <span class="ex">pkgs</span> = import <span class="op">&lt;</span>nixpkgs<span class="op">&gt;</span> {};</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw">in</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>  <span class="ex">pkgs.mkShell</span> {</span>
<span id="cb1-5"><a href="#cb1-5"></a>    <span class="ex">name</span> = <span class="st">&quot;simpleEnv&quot;</span><span class="kw">;</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>    <span class="ex">buildInputs</span> = with pkgs<span class="kw">;</span><span class="bu"> [</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>    <span class="co"># basic python dependencies</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>      python37</span>
<span id="cb1-9"><a href="#cb1-9"></a>      python37Packages.numpy</span>
<span id="cb1-10"><a href="#cb1-10"></a>      python37Packages.scikitlearn</span>
<span id="cb1-11"><a href="#cb1-11"></a>      python37Packages.scipy</span>
<span id="cb1-12"><a href="#cb1-12"></a>      python37Packages.matplotlib</span>
<span id="cb1-13"><a href="#cb1-13"></a>    <span class="co"># a couple of deep learning libraries</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>      python37Packages.tensorflowWithCuda <span class="co"># note if you get rid of WithCuda then you will not be using Cuda</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>      python37Packages.Keras</span>
<span id="cb1-16"><a href="#cb1-16"></a>      python37Packages.pytorchWithCuda</span>
<span id="cb1-17"><a href="#cb1-17"></a></span>
<span id="cb1-18"><a href="#cb1-18"></a>    <span class="co"># Lets assume we also want to use R, maybe to compare sklearn and R models</span></span>
<span id="cb1-19"><a href="#cb1-19"></a>      R</span>
<span id="cb1-20"><a href="#cb1-20"></a>      rPackages.mlr</span>
<span id="cb1-21"><a href="#cb1-21"></a>      rPackages.data_table <span class="co"># &quot;_&quot; replaces &quot;.&quot;</span></span>
<span id="cb1-22"><a href="#cb1-22"></a>      rPackages.ggplot2</span>
<span id="cb1-23"><a href="#cb1-23"></a>    ];</span>
<span id="cb1-24"><a href="#cb1-24"></a>   shellHook <span class="ot">=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb1-25"><a href="#cb1-25"></a>      <span class="st">&#39;&#39;</span>;</span>
<span id="cb1-26"><a href="#cb1-26"></a>  }</span></code></pre></div>
<p>Now, lets walk through the code.</p>
<div id="let-in" class="section level2">
<h2>let … in</h2>
<p>First, we define I would say really our imports. I am not sure what the technical word for this is but its the stuff in between let and in.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a><span class="bu">let</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="ex">pkgs</span> = import <span class="op">&lt;</span>nixpkgs<span class="op">&gt;</span> {};</span></code></pre></div>
<p>On the left hand half of the equation (this is simple review, but it is intimidating seeing a new language), we have the name of the variable, which can be called after <code>in</code>. Next we have the trickier statement:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="ex">import</span> <span class="op">&lt;</span>nixpkgs<span class="op">&gt;</span> {};</span></code></pre></div>
<p>What this is doing is naming our connection to the nix package repository (<code>&lt;nixpkgs&gt;</code>) online. The thing in the <code>&lt;&gt;</code> is the name of the nix channel we are connecting to. This is really boilerplate and will never change for any of our use case. We will see later on what the <code>{}</code> does. Basically it is a space for any options or specific parts of <code>&lt;nixpkgs&gt;</code> we want to import. For now, it is just boilerplate.</p>
</div>
<div id="pkgs.mkshell" class="section level2">
<h2>pkgs.mkShell</h2>
<p>Here is the first important bit. We are building what is called a <code>nix shell</code>. What this is, is when you type <code>nix-shell</code> in this directory on the command line, your computer is going to drop you into a new shell with the little environment we are building in its $PATH. This means you can still access your computer and all your files, but also access these include packages, without having it affect your system or touch any of your other environments.</p>
<p>The <code>name = "simpleEnv"</code> line is very simple, we are specifying what the name of our environment package will be in /nix/store. It is also the name it will appear as in our shell.</p>
<p>Next we come to the buildInputs. <strong><em>This is where you put the packages</em></strong>. Note that <code>with pkgs; [...]</code> essentially means we dont have to type</p>
<pre><code>pkgs.python37
pkgs.python37Packages.numpy
...
...</code></pre>
<p>thankfully.</p>
<p>Finally, after this bit, we have an optional <code>shellHook = '' ''</code> line. This allows us to run any scripts, set up any services, or anything like that we may want to do. For me this line is useful when developing R packages, but otherwise I do not use.</p>
<p>And that is it :) You have made your first isolated, reproducible environment in Nix. To activate it, simply cd into the directory where the shell.nix is located, and type <code>nix-shell</code>. Note that if this is slow, you may want to try <code>nix-shell -j 8</code>, or however many cores you have, to make it build faster.</p>
</div>
</div>
<div id="but-what-if-my-python-package-isnt-in-nixpkgs" class="section level1">
<h1>But what if my python package isnt in nixpkgs?</h1>
<p>Let us say we are also interested in the cool data science visualization package <a href="https://www.scikit-yb.org/en/latest/">yellowbrick</a>. First, lets search the nix repository for it, using a convenient command line tool:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="ex">nix</span> search yellowbrick</span></code></pre></div>
<p>We can search for anything this way, with results automatically popping out in less. Unfortunately, this gives us no results. That means yellowbrick, which is in pypi, is not available in nipkgs by default. This is not the end of the world by any means, and we have a few ways to deal with it:</p>
<div id="method-one-cheating-and-using-virtualenv-like-a-baby" class="section level2">
<h2>Method one: Cheating and using virtualenv like a baby</h2>
<p>This time, we can just cheat, and use virtualenv in our shellHook along with requirements.txt. This is super lame, impure, and not advised, but sometimes we are all lazy. Please note the simple changes we made to wrap our nix environment in a virtualenv:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="bu">let</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>  <span class="ex">pkgs</span> = import <span class="op">&lt;</span>nixpkgs<span class="op">&gt;</span> {};</span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="kw">in</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="ex">pkgs.mkShell</span> {</span>
<span id="cb6-5"><a href="#cb6-5"></a>    <span class="ex">name</span> = <span class="st">&quot;simpleEnv&quot;</span><span class="kw">;</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>    <span class="ex">buildInputs</span> = with pkgs<span class="kw">;</span><span class="bu"> [</span></span>
<span id="cb6-7"><a href="#cb6-7"></a>    <span class="co"># basic python dependencies</span></span>
<span id="cb6-8"><a href="#cb6-8"></a>      python37</span>
<span id="cb6-9"><a href="#cb6-9"></a>      python37Packages.numpy</span>
<span id="cb6-10"><a href="#cb6-10"></a>      python37Packages.scikitlearn</span>
<span id="cb6-11"><a href="#cb6-11"></a>      python37Packages.scipy</span>
<span id="cb6-12"><a href="#cb6-12"></a>      python37Packages.matplotlib</span>
<span id="cb6-13"><a href="#cb6-13"></a></span>
<span id="cb6-14"><a href="#cb6-14"></a></span>
<span id="cb6-15"><a href="#cb6-15"></a>    <span class="co"># a couple of deep learning libraries</span></span>
<span id="cb6-16"><a href="#cb6-16"></a>      python37Packages.tensorflow</span>
<span id="cb6-17"><a href="#cb6-17"></a>    <span class="co"># python37Packages.tensorflowWithCuda # note if you get rid of WithCuda then you will not be using Cuda</span></span>
<span id="cb6-18"><a href="#cb6-18"></a>      python37Packages.Keras</span>
<span id="cb6-19"><a href="#cb6-19"></a>      python37Packages.pytorch <span class="co"># used for speedy examples</span></span>
<span id="cb6-20"><a href="#cb6-20"></a>    <span class="co"># python37Packages.pytorchWithCuda</span></span>
<span id="cb6-21"><a href="#cb6-21"></a></span>
<span id="cb6-22"><a href="#cb6-22"></a>    <span class="co"># Lets assume we also want to use R, maybe to compare sklearn and R models</span></span>
<span id="cb6-23"><a href="#cb6-23"></a>      R</span>
<span id="cb6-24"><a href="#cb6-24"></a>      rPackages.mlr</span>
<span id="cb6-25"><a href="#cb6-25"></a>      rPackages.data_table <span class="co"># &quot;_&quot; replaces &quot;.&quot;</span></span>
<span id="cb6-26"><a href="#cb6-26"></a>      rPackages.ggplot2</span>
<span id="cb6-27"><a href="#cb6-27"></a></span>
<span id="cb6-28"><a href="#cb6-28"></a>    <span class="co"># dirty virtualenv dependencies</span></span>
<span id="cb6-29"><a href="#cb6-29"></a>      python37Packages.pip</span>
<span id="cb6-30"><a href="#cb6-30"></a>      python37Packages.virtualenv</span>
<span id="cb6-31"><a href="#cb6-31"></a>    ];</span>
<span id="cb6-32"><a href="#cb6-32"></a>   shellHook <span class="ot">=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb6-33"><a href="#cb6-33"></a>    echo <span class="st">&quot;yellowbrick&quot;</span> <span class="ot">&gt;</span> requirements.txt</span>
<span id="cb6-34"><a href="#cb6-34"></a>    virtualenv simpleEnv</span>
<span id="cb6-35"><a href="#cb6-35"></a>    source simpleEnv/bin/activate</span>
<span id="cb6-36"><a href="#cb6-36"></a>    pip install <span class="ot">-r</span> requirements.txt </span>
<span id="cb6-37"><a href="#cb6-37"></a>      <span class="st">&#39;&#39;</span>;</span>
<span id="cb6-38"><a href="#cb6-38"></a>  }</span></code></pre></div>
<p>This will always work, but it is incredibly lame, and we cant do cooler things with this. We are simply putting yellowbrick in requirements.txt, activating a virtualenv, and then installing it, after we enter the nix shell. This is two layers of abstraction, but it is definitely possible. Not recommended at all.</p>
</div>
<div id="doing-it-the-nix-way" class="section level2">
<h2>Doing it the Nix way</h2>
<p>Doing this the nix way is very simple. We can pull the package from PyPi (or GitHub/GitLab/wherever) using two lovely Nix builtins: <code>fetchFromPyPi</code> and <code>fetchFromGithub</code> (very appropriately named). Lets now proceed to fetch yellowBrick from PyPi in the let … in section of our <code>shell.nix</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="bu">let</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>  <span class="ex">pkgs</span> = import <span class="op">&lt;</span>nixpkgs<span class="op">&gt;</span> {};</span>
<span id="cb7-4"><a href="#cb7-4"></a></span>
<span id="cb7-5"><a href="#cb7-5"></a></span>
<span id="cb7-6"><a href="#cb7-6"></a>  <span class="co"># bring in yellowbrick from pypi, building it with a recursive list</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>    <span class="ex">yellowbrick</span> = pkgs.python37.pkgs.buildPythonPackage rec {</span>
<span id="cb7-8"><a href="#cb7-8"></a>      <span class="ex">pname</span> = <span class="st">&quot;yellowbrick&quot;</span><span class="kw">;</span></span>
<span id="cb7-9"><a href="#cb7-9"></a>      <span class="ex">version</span> = <span class="st">&quot;1.0.1&quot;</span> <span class="kw">;</span></span>
<span id="cb7-10"><a href="#cb7-10"></a></span>
<span id="cb7-11"><a href="#cb7-11"></a>      <span class="ex">src</span> = pkgs.python37.pkgs.fetchPypi {</span>
<span id="cb7-12"><a href="#cb7-12"></a>        <span class="ex">inherit</span> pname version<span class="kw">;</span></span>
<span id="cb7-13"><a href="#cb7-13"></a>        <span class="ex">sha256</span> = <span class="st">&quot;1q659ayr657p786gwrh11lw56jw5bdpnl6hp11qlckvh15haywvk&quot;</span><span class="kw">;</span></span>
<span id="cb7-14"><a href="#cb7-14"></a>      };</span>
<span id="cb7-15"><a href="#cb7-15"></a></span>
<span id="cb7-16"><a href="#cb7-16"></a><span class="co"># no tests because this is a simple example</span></span>
<span id="cb7-17"><a href="#cb7-17"></a>      <span class="ex">doCheck</span> = false<span class="kw">;</span></span>
<span id="cb7-18"><a href="#cb7-18"></a></span>
<span id="cb7-19"><a href="#cb7-19"></a><span class="co"># dependencies for yellowbrick</span></span>
<span id="cb7-20"><a href="#cb7-20"></a>      <span class="ex">buildInputs</span> = with pkgs.python37Packages<span class="kw">;</span><span class="bu"> [</span></span>
<span id="cb7-21"><a href="#cb7-21"></a>      pytest </span>
<span id="cb7-22"><a href="#cb7-22"></a>      pytestrunner </span>
<span id="cb7-23"><a href="#cb7-23"></a>      pytest-flakes  </span>
<span id="cb7-24"><a href="#cb7-24"></a>      numpy </span>
<span id="cb7-25"><a href="#cb7-25"></a>      matplotlib </span>
<span id="cb7-26"><a href="#cb7-26"></a>      scipy </span>
<span id="cb7-27"><a href="#cb7-27"></a>      scikitlearn</span>
<span id="cb7-28"><a href="#cb7-28"></a>    ];</span>
<span id="cb7-29"><a href="#cb7-29"></a>  };</span>
<span id="cb7-30"><a href="#cb7-30"></a>in</span>
<span id="cb7-31"><a href="#cb7-31"></a>  pkgs.mkShell {</span>
<span id="cb7-32"><a href="#cb7-32"></a>    name <span class="ot">=</span> <span class="st">&quot;simpleEnv&quot;</span>;</span>
<span id="cb7-33"><a href="#cb7-33"></a>    buildInputs <span class="ot">=</span> with pkgs; [</span>
<span id="cb7-34"><a href="#cb7-34"></a>    <span class="co"># basic python dependencies</span></span>
<span id="cb7-35"><a href="#cb7-35"></a>      python37</span>
<span id="cb7-36"><a href="#cb7-36"></a>      python37Packages.numpy</span>
<span id="cb7-37"><a href="#cb7-37"></a>      python37Packages.scikitlearn</span>
<span id="cb7-38"><a href="#cb7-38"></a>      python37Packages.scipy</span>
<span id="cb7-39"><a href="#cb7-39"></a>      python37Packages.matplotlib</span>
<span id="cb7-40"><a href="#cb7-40"></a>    <span class="co"># a couple of deep learning libraries</span></span>
<span id="cb7-41"><a href="#cb7-41"></a>      python37Packages.tensorflow</span>
<span id="cb7-42"><a href="#cb7-42"></a>    <span class="co"># python37Packages.tensorflowWithCuda # note if you get rid of WithCuda then you will not be using Cuda</span></span>
<span id="cb7-43"><a href="#cb7-43"></a>      python37Packages.Keras</span>
<span id="cb7-44"><a href="#cb7-44"></a>      python37Packages.pytorch <span class="co"># used for speedy examples</span></span>
<span id="cb7-45"><a href="#cb7-45"></a>    <span class="co"># python37Packages.pytorchWithCuda</span></span>
<span id="cb7-46"><a href="#cb7-46"></a></span>
<span id="cb7-47"><a href="#cb7-47"></a>    <span class="co"># Lets assume we also want to use R, maybe to compare sklearn and R models</span></span>
<span id="cb7-48"><a href="#cb7-48"></a>      R</span>
<span id="cb7-49"><a href="#cb7-49"></a>      rPackages.mlr</span>
<span id="cb7-50"><a href="#cb7-50"></a>      rPackages.data_table <span class="co"># &quot;_&quot; replaces &quot;.&quot;</span></span>
<span id="cb7-51"><a href="#cb7-51"></a>      rPackages.ggplot2</span>
<span id="cb7-52"><a href="#cb7-52"></a></span>
<span id="cb7-53"><a href="#cb7-53"></a>      yellowbrick</span>
<span id="cb7-54"><a href="#cb7-54"></a>    ];</span>
<span id="cb7-55"><a href="#cb7-55"></a>   shellHook <span class="ot">=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb7-56"><a href="#cb7-56"></a>      <span class="st">&#39;&#39;</span>;</span>
<span id="cb7-57"><a href="#cb7-57"></a>  }</span></code></pre></div>
<p>Lets now walk through this code, which seems very scary but is actually very simple.</p>
<p>First important bit is <code>pkgs.python37.pkgs.buildPythonPackage</code>, which is calling from nixpkgs (online repo), the buildPythonPackage function, which clearly allows us to build a python package. As an input, this function takes in a recursive set <code>rec {...}</code>.</p>
<p>The first thing we need to specify is the package name (<code>pname</code>), and the package version. Next, we need to specify the source (<code>src</code>) of the package, or where it comes from. This calls the name and the version of the package mentioned above, as well as a SHA256 hash sent in from Pypi. To get this hash, we can either do it an <a href="https://github.com/target/nix-fetchers">elegant and pure way</a>, or the lazy David way. To get the proper hash the lazy way, simply put the wrong hash in and let nix correct you.</p>
<p>After that, we need to construct our tree. For this simple example. we will not run any python checkPhase, so we will say <code>doCheck = false</code>. After this example we will desimplify the recipe a bit.</p>
<p>The final step is we need to specify what dependencies are needed to build our package. In this case we use <code>buildInputs</code>. In this case, the package will not build without pytest et al, matplotlib, numpy, scipy, and sklearn. And that is it. Go ahead and try running the following code, to test that it worked:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a><span class="im">import</span> sklearn.datasets</span>
<span id="cb8-2"><a href="#cb8-2"></a>X,Y <span class="op">=</span> sklearn.datasets.load_breast_cancer(return_X_y<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="im">from</span> yellowbrick.features <span class="im">import</span> ParallelCoordinates</span>
<span id="cb8-5"><a href="#cb8-5"></a></span>
<span id="cb8-6"><a href="#cb8-6"></a>visualizer <span class="op">=</span> ParallelCoordinates()</span>
<span id="cb8-7"><a href="#cb8-7"></a>visualizer.fit_transform(X, Y)</span>
<span id="cb8-8"><a href="#cb8-8"></a>visualizer.show()</span></code></pre></div>
</div>
<div id="desimplifying-buildinputs" class="section level2">
<h2>Desimplifying buildInputs</h2>
<p>Lets assume we are building production code. Obviously, we will probably want to run the checks on our package. So the first thing we do is we delete the <code>doCheck =  false</code> line. The next thing we need to do is move the test dependencies away from buildInputs. These are actually only used during the check phase, so we write a new set of inputs, <code>checkInputs</code></p>
<p>In this case we will now have</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1"></a><span class="ex">checkInputs</span> = with pkgs.python37Packages<span class="kw">;</span><span class="bu"> [</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>  pytest</span>
<span id="cb9-3"><a href="#cb9-3"></a>  pytestruner</span>
<span id="cb9-4"><a href="#cb9-4"></a>  pytest-flakes</span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="bu">]</span>;</span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="ex">buildInputs</span> = with pkgs.python37Packages<span class="kw">;</span><span class="bu"> [</span></span>
<span id="cb9-7"><a href="#cb9-7"></a>  numpy </span>
<span id="cb9-8"><a href="#cb9-8"></a>  matplotlib </span>
<span id="cb9-9"><a href="#cb9-9"></a>  scipy </span>
<span id="cb9-10"><a href="#cb9-10"></a>  scikitlearn</span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="bu">]</span>;</span></code></pre></div>
<p>So pytest and friends will be called during the check phase, and the rest will be called when actually constructing the package. Finally, if there were some other packages that were <code>runtime dependencies</code> for the python package we were to install, we would put them in <code>propogatedBuildInputs</code>. For more extensive and technical documentation on doing this, please refer to the excellent <a href="https://github.com/NixOS/nixpkgs/blob/master/doc/languages-frameworks/python.section.md">nix python documentation</a></p>
</div>
</div>
<div id="how-can-i-make-this-quicker" class="section level1">
<h1>How can I make this quicker??</h1>
<p>One thing you may notice, especially if you are compiling your environment to run with Cuda, is this build can take forever. Sometimes you end up having to compile very big packages, and this is never quick business. Thankfully, there is an amazing workaround to that. We can actually construct our environment as an honest to goodness package, in binary form, and then put that binary in an online cache, so we can simply download our tree whenever we want to use it. This is also an incredible tool for working in teams when you want total reproducibility. Every member of the team will have the exact same environment compiled under the exact same system.</p>
<p>For this, we will use <a href="https://cachix.org/">cachix</a>. The first thing we are going to do is write a new file, <code>default.nix</code>, which we build a nix <strong><em>derivation</em></strong>(read: recipe) which compiles to a binary which we can dump into the online cache.</p>
<p>We will need to change the boilerplate code slightly to get this to work, but in general this is simple. As with the other examples, I will show it first then walk through what we did:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a><span class="bu">let</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>  <span class="ex">pkgs</span> = import <span class="op">&lt;</span>nixpkgs<span class="op">&gt;</span> {}; <span class="co"># standard</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>  <span class="co"># bring in yellowbrick from pypi, building it with a recursive list</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>    <span class="ex">yellowbrick</span> = pkgs.python37.pkgs.buildPythonPackage rec {</span>
<span id="cb10-5"><a href="#cb10-5"></a>      <span class="ex">pname</span> = <span class="st">&quot;yellowbrick&quot;</span><span class="kw">;</span></span>
<span id="cb10-6"><a href="#cb10-6"></a>      <span class="ex">version</span> = <span class="st">&quot;1.0.1&quot;</span><span class="kw">;</span></span>
<span id="cb10-7"><a href="#cb10-7"></a></span>
<span id="cb10-8"><a href="#cb10-8"></a>      <span class="ex">src</span> = pkgs.python37.pkgs.fetchPypi {</span>
<span id="cb10-9"><a href="#cb10-9"></a>        <span class="ex">inherit</span> pname version<span class="kw">;</span></span>
<span id="cb10-10"><a href="#cb10-10"></a>        <span class="ex">sha256</span> = <span class="st">&quot;1q659ayr657p786gwrh11lw56jw5bdpnl6hp11qlckvh15haywvk&quot;</span><span class="kw">;</span></span>
<span id="cb10-11"><a href="#cb10-11"></a>      };</span>
<span id="cb10-12"><a href="#cb10-12"></a></span>
<span id="cb10-13"><a href="#cb10-13"></a><span class="co"># no tests because this is a simple example</span></span>
<span id="cb10-14"><a href="#cb10-14"></a>      <span class="ex">doCheck</span> = false<span class="kw">;</span></span>
<span id="cb10-15"><a href="#cb10-15"></a></span>
<span id="cb10-16"><a href="#cb10-16"></a><span class="co"># dependencies for yellowbrick</span></span>
<span id="cb10-17"><a href="#cb10-17"></a>      <span class="ex">buildInputs</span> = with pkgs.python37Packages<span class="kw">;</span><span class="bu"> [</span></span>
<span id="cb10-18"><a href="#cb10-18"></a>      pytest </span>
<span id="cb10-19"><a href="#cb10-19"></a>      pytestrunner </span>
<span id="cb10-20"><a href="#cb10-20"></a>      pytest-flakes  </span>
<span id="cb10-21"><a href="#cb10-21"></a>      numpy </span>
<span id="cb10-22"><a href="#cb10-22"></a>      matplotlib </span>
<span id="cb10-23"><a href="#cb10-23"></a>      scipy </span>
<span id="cb10-24"><a href="#cb10-24"></a>      scikitlearn</span>
<span id="cb10-25"><a href="#cb10-25"></a>    ];</span>
<span id="cb10-26"><a href="#cb10-26"></a>  };</span>
<span id="cb10-27"><a href="#cb10-27"></a>  in with import &lt;nixpkgs<span class="ot">&gt;</span> {};</span>
<span id="cb10-28"><a href="#cb10-28"></a>stdenv.mkDerivation rec { <span class="co"># new boilerplate</span></span>
<span id="cb10-29"><a href="#cb10-29"></a>  name <span class="ot">=</span> <span class="st">&quot;simpleEnv&quot;</span>;</span>
<span id="cb10-30"><a href="#cb10-30"></a></span>
<span id="cb10-31"><a href="#cb10-31"></a>  <span class="co"># Mandatory boilerplate for buildable env</span></span>
<span id="cb10-32"><a href="#cb10-32"></a>  <span class="co"># this boilerplate is courtesy of Asko Soukka</span></span>
<span id="cb10-33"><a href="#cb10-33"></a>  env <span class="ot">=</span> buildEnv { name <span class="ot">=</span> name; paths <span class="ot">=</span> buildInputs; };</span>
<span id="cb10-34"><a href="#cb10-34"></a>  builder <span class="ot">=</span> builtins.toFile <span class="st">&quot;builder.sh&quot;</span> <span class="st">&#39;&#39;</span></span>
<span id="cb10-35"><a href="#cb10-35"></a>    source <span class="va">$stdenv</span>/setup; ln <span class="ot">-s</span> <span class="va">$env</span> <span class="va">$out</span></span>
<span id="cb10-36"><a href="#cb10-36"></a>  <span class="st">&#39;&#39;</span>;</span>
<span id="cb10-37"><a href="#cb10-37"></a></span>
<span id="cb10-38"><a href="#cb10-38"></a>  buildInputs <span class="ot">=</span> [</span>
<span id="cb10-39"><a href="#cb10-39"></a></span>
<span id="cb10-40"><a href="#cb10-40"></a>      python37</span>
<span id="cb10-41"><a href="#cb10-41"></a>      python37Packages.numpy</span>
<span id="cb10-42"><a href="#cb10-42"></a>      python37Packages.scikitlearn</span>
<span id="cb10-43"><a href="#cb10-43"></a>      python37Packages.scipy</span>
<span id="cb10-44"><a href="#cb10-44"></a>      python37Packages.matplotlib</span>
<span id="cb10-45"><a href="#cb10-45"></a>      yellowbrick</span>
<span id="cb10-46"><a href="#cb10-46"></a></span>
<span id="cb10-47"><a href="#cb10-47"></a>      python37Packages.tensorflowWithCuda</span>
<span id="cb10-48"><a href="#cb10-48"></a>      python37Packages.Keras</span>
<span id="cb10-49"><a href="#cb10-49"></a>      python37Packages.pytorchWithCuda</span>
<span id="cb10-50"><a href="#cb10-50"></a></span>
<span id="cb10-51"><a href="#cb10-51"></a>      R</span>
<span id="cb10-52"><a href="#cb10-52"></a>      rPackages.mlr</span>
<span id="cb10-53"><a href="#cb10-53"></a>      rPackages.data_table <span class="co"># &quot;_&quot; replaces &quot;.&quot;</span></span>
<span id="cb10-54"><a href="#cb10-54"></a>      rPackages.ggplot2</span>
<span id="cb10-55"><a href="#cb10-55"></a>  ];</span>
<span id="cb10-56"><a href="#cb10-56"></a></span>
<span id="cb10-57"><a href="#cb10-57"></a>}</span></code></pre></div>
<p>And there we have it. We have built our first nix package/recipe. Lets now talk through the boilerplate.</p>
<p>The first thing we notice is instead of mkShell, we are using stdenv.mkDerivation, which makes a nix derivation (recipe). It is defined with a recursive set <code>rec</code>. Next, just as in the shell.nix, we give it a name. Then, in the <code>env = ...</code> bit, we define where nix should look to build the environment. In this case, it should look for the name we made, and the build inputs we define next.</p>
<p>We also have to define what tool is going to build it, in this case we are using a builtin (to nix) build script, which again is just boilerplate.</p>
<p>Finally, we have our buildInputs as usual, and then we are done. To see what we have done, try <code>nix-build</code> in the directory containing <code>default.nix</code> (you can also <code>nix-build default.nix</code>, but that is not needed). we can now look around the tree for the package which we are made, which is symlinked to <code>/nix/store/longhash-simpleEnv</code>.</p>
<p>To get this on an online cache, so we dont have to build our environment over and over, first you must sign up for cachix. Then, try out <code>cachix create simpleEnv</code>, so you create room in the online cache for you.</p>
<p>Next, enter in <code>nix-build | cachix push simpleEnv</code>. This builds the derivation and pipes the binary into the cachix push command and stores it.</p>
<p>Now, simply type <code>cachix use simpleEnv</code>. This connects your computer to your lovely cache, and any time you are using a package that is part of this environment, in nix shell or otherwise, it will instead of being built slowly, simply pull down that cached binary onto your computer.</p>
</div>
<div id="until-next-time" class="section level1">
<h1>Until next time</h1>
<p>Hopefully, you now can quickly create nix environments for your data science workflow, and a bit of the boilerplate nix is demystified. Next time, we will look at building a container from nix expressions, fully reproducible Jupyter Notebooks and kernels, and packaging a machine learning model using nix (and deploying it as a service).</p>
</div>
<div id="references" class="section level1">
<h1>References</h1>
<p>For more info from people significantly smarter than I, check out:</p>
<ul>
<li><p><a href="https://github.com/NixOS/nixpkgs/blob/master/doc/languages-frameworks/python.section.md">nix python documentation</a></p></li>
<li><p><a href="https://datakurre.pandala.org/2015/10/nix-for-python-developers.html/">Asko Soukka’s Brilliant Blog</a></p></li>
</ul>
<p><a href="nix2.html">part 2</a></p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
