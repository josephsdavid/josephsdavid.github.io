<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="David Josephs" />

<meta name="date" content="2020-03-17" />

<title>Practical Nix for Data Science: Part 2</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/readable.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />
<link href="site_libs/ionicons-2.0.1/css/ionicons.min.css" rel="stylesheet" />


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; } /* Alert */
code span.an { color: #008000; } /* Annotation */
code span.at { } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #0000ff; } /* ControlFlow */
code span.ch { color: #008080; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008000; } /* Comment */
code span.cv { color: #008000; } /* CommentVar */
code span.do { color: #008000; } /* Documentation */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.im { } /* Import */
code span.in { color: #008000; } /* Information */
code span.kw { color: #0000ff; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #ff4000; } /* Other */
code span.pp { color: #ff4000; } /* Preprocessor */
code span.sc { color: #008080; } /* SpecialChar */
code span.ss { color: #008080; } /* SpecialString */
code span.st { color: #008080; } /* String */
code span.va { } /* Variable */
code span.vs { color: #008080; } /* VerbatimString */
code span.wa { color: #008000; font-weight: bold; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 66px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h2 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h3 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h4 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h5 {
  padding-top: 71px;
  margin-top: -71px;
}
.section h6 {
  padding-top: 71px;
  margin-top: -71px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-inverse  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">David Does Data</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Nix
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="nix.html">Nix for Data Science 1</a>
    </li>
    <li>
      <a href="nix2.html">Nix for Data Science 2: COMING SOON</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    IML
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="iml.html">Interpretable Machine Learning: Part 1</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Time Series
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="tsEDA.html">Time Series EDA</a>
    </li>
    <li>
      <a href="tspreprocessing.html">Time Series Cleaning</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/josephsdavid">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="https://twitter.com/Daved256">
    <span class="ion ion-social-twitter"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Practical Nix for Data Science: Part 2</h1>
<h4 class="author">David Josephs</h4>
<h4 class="date">2020-03-17</h4>

</div>


<p><a href="nix.html">Nix part 1</a></p>
<p>In this post, we will get into some very cool data science specific uses for Nix, as I have seen a few <a href="https://twitter.com/chipro/status/1202815757593108480?s=20">questions on twitter related to machine learning software stacks</a>. We will discuss A) building models reproducibly with nix, and hosting them on a <a href="https://cachix.org/">binary cache</a> and B) integrating this with <a href="https://hercules-ci.com/">continuous integration</a></p>
<div id="reproducibly-building-models" class="section level1">
<h1>Reproducibly Building Models</h1>
<p>A prerequisite for this post is reading and understanding my <a href="nix.html">previous post on nix</a>, as we are about to get into some more complex stuff. Specifically read through the building and hosting on a binary cache section. In this case, we are going to learn to include source code that is not in nixpkgs, instead it will be our own source code, which trains a model! Lets get started. First, lets go over the directory structure for our project:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="ex">.</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>├── <span class="ex">default.nix</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>├── <span class="ex">model.nix</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>├── <span class="ex">shell.nix</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>└── <span class="ex">py</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>    └── <span class="ex">trainer</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>        └── <span class="ex">train.py</span></span></code></pre></div>
<p>The important files here are <code>default.nix</code>, <code>model.nix</code>, and <code>py/*</code>. What we are going to do is build our project from the bottom up, starting with the trainer python file, then building a nix expression for it, then we build our default.nix, which compiles everything together. For full reproducibility, I will also demonstrate how to pin nixpkgs, for true determinism! The <code>shell.nix</code> is optional and used for my development environment. Note, I will be following an example <a href="https://github.com/Tokyo-NixOS/presentations">from the tokyo nixos meetup</a>, except simplifying some things and overcomplicating others.</p>
<div id="defining-the-model" class="section level2">
<h2>Defining the Model</h2>
<p>First, lets build a simple keras model:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Sequential</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Dense, Dropout, Flatten</span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Conv2D, MaxPooling2D</span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="im">import</span> os</span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="kw">class</span> ModelTrainer:</span>
<span id="cb2-9"><a href="#cb2-9"></a></span>
<span id="cb2-10"><a href="#cb2-10"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb2-11"><a href="#cb2-11"></a>         <span class="co"># we will define these in model.nix, as build variables!</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>         <span class="va">self</span>.epochs     <span class="op">=</span> <span class="bu">int</span>( os.environ.get(<span class="st">&#39;EPOCHS&#39;</span>, <span class="dv">12</span>) )</span>
<span id="cb2-13"><a href="#cb2-13"></a>         <span class="co"># Reproducible data!</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>         <span class="va">self</span>.data_file  <span class="op">=</span> os.environ.get(<span class="st">&#39;DATA&#39;</span>)</span>
<span id="cb2-15"><a href="#cb2-15"></a>         <span class="co"># where we save the model</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>         <span class="va">self</span>.model_file <span class="op">=</span> os.environ.get(<span class="st">&#39;MODEL&#39;</span>, <span class="st">&#39;model.h5&#39;</span>)</span>
<span id="cb2-17"><a href="#cb2-17"></a></span>
<span id="cb2-18"><a href="#cb2-18"></a>    <span class="kw">def</span> load_data(<span class="va">self</span>, <span class="bu">file</span>):</span>
<span id="cb2-19"><a href="#cb2-19"></a>        f <span class="op">=</span> np.load(<span class="va">self</span>.data_file)</span>
<span id="cb2-20"><a href="#cb2-20"></a>        <span class="cf">return</span> (f[<span class="st">&#39;x_train&#39;</span>], f[<span class="st">&#39;y_train&#39;</span>]), (f[<span class="st">&#39;x_test&#39;</span>], f[<span class="st">&#39;y_test&#39;</span>])</span>
<span id="cb2-21"><a href="#cb2-21"></a></span>
<span id="cb2-22"><a href="#cb2-22"></a>    <span class="kw">def</span> train(<span class="va">self</span>):</span>
<span id="cb2-23"><a href="#cb2-23"></a>        <span class="co"># input image dimensions</span></span>
<span id="cb2-24"><a href="#cb2-24"></a>        img_rows, img_cols <span class="op">=</span> <span class="dv">28</span>, <span class="dv">28</span></span>
<span id="cb2-25"><a href="#cb2-25"></a></span>
<span id="cb2-26"><a href="#cb2-26"></a>        batch_size <span class="op">=</span> <span class="dv">128</span></span>
<span id="cb2-27"><a href="#cb2-27"></a>        num_classes <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb2-28"><a href="#cb2-28"></a></span>
<span id="cb2-29"><a href="#cb2-29"></a>        epochs <span class="op">=</span> <span class="va">self</span>.epochs</span>
<span id="cb2-30"><a href="#cb2-30"></a></span>
<span id="cb2-31"><a href="#cb2-31"></a>        (x_train, y_train), (x_test, y_test) <span class="op">=</span> <span class="va">self</span>.load_data(<span class="va">self</span>.data_file)</span>
<span id="cb2-32"><a href="#cb2-32"></a>        </span>
<span id="cb2-33"><a href="#cb2-33"></a>        <span class="cf">if</span> K.image_data_format() <span class="op">==</span> <span class="st">&#39;channels_first&#39;</span>:</span>
<span id="cb2-34"><a href="#cb2-34"></a>            x_train <span class="op">=</span> x_train.reshape(x_train.shape[<span class="dv">0</span>], <span class="dv">1</span>, img_rows, img_cols)</span>
<span id="cb2-35"><a href="#cb2-35"></a>            x_test <span class="op">=</span> x_test.reshape(x_test.shape[<span class="dv">0</span>], <span class="dv">1</span>, img_rows, img_cols)</span>
<span id="cb2-36"><a href="#cb2-36"></a>            input_shape <span class="op">=</span> (<span class="dv">1</span>, img_rows, img_cols)</span>
<span id="cb2-37"><a href="#cb2-37"></a>        <span class="cf">else</span>:</span>
<span id="cb2-38"><a href="#cb2-38"></a>            x_train <span class="op">=</span> x_train.reshape(x_train.shape[<span class="dv">0</span>], img_rows, img_cols, <span class="dv">1</span>)</span>
<span id="cb2-39"><a href="#cb2-39"></a>            x_test <span class="op">=</span> x_test.reshape(x_test.shape[<span class="dv">0</span>], img_rows, img_cols, <span class="dv">1</span>)</span>
<span id="cb2-40"><a href="#cb2-40"></a>            input_shape <span class="op">=</span> (img_rows, img_cols, <span class="dv">1</span>)</span>
<span id="cb2-41"><a href="#cb2-41"></a>        </span>
<span id="cb2-42"><a href="#cb2-42"></a>        x_train <span class="op">=</span> x_train.astype(<span class="st">&#39;float32&#39;</span>)</span>
<span id="cb2-43"><a href="#cb2-43"></a>        x_test <span class="op">=</span> x_test.astype(<span class="st">&#39;float32&#39;</span>)</span>
<span id="cb2-44"><a href="#cb2-44"></a>        x_train <span class="op">/=</span> <span class="dv">255</span></span>
<span id="cb2-45"><a href="#cb2-45"></a>        x_test <span class="op">/=</span> <span class="dv">255</span></span>
<span id="cb2-46"><a href="#cb2-46"></a>        <span class="bu">print</span>(<span class="st">&#39;x_train shape:&#39;</span>, x_train.shape)</span>
<span id="cb2-47"><a href="#cb2-47"></a>        <span class="bu">print</span>(x_train.shape[<span class="dv">0</span>], <span class="st">&#39;train samples&#39;</span>)</span>
<span id="cb2-48"><a href="#cb2-48"></a>        <span class="bu">print</span>(x_test.shape[<span class="dv">0</span>], <span class="st">&#39;test samples&#39;</span>)</span>
<span id="cb2-49"><a href="#cb2-49"></a>        </span>
<span id="cb2-50"><a href="#cb2-50"></a>        <span class="co"># convert class vectors to binary class matrices</span></span>
<span id="cb2-51"><a href="#cb2-51"></a>        y_train <span class="op">=</span> tf.keras.utils.to_categorical(y_train, num_classes)</span>
<span id="cb2-52"><a href="#cb2-52"></a>        y_test <span class="op">=</span> tf.keras.utils.to_categorical(y_test, num_classes)</span>
<span id="cb2-53"><a href="#cb2-53"></a>        </span>
<span id="cb2-54"><a href="#cb2-54"></a>        model <span class="op">=</span> Sequential()</span>
<span id="cb2-55"><a href="#cb2-55"></a>        model.add(Conv2D(<span class="dv">32</span>, kernel_size<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">3</span>),</span>
<span id="cb2-56"><a href="#cb2-56"></a>                         activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>,</span>
<span id="cb2-57"><a href="#cb2-57"></a>                         input_shape<span class="op">=</span>input_shape))</span>
<span id="cb2-58"><a href="#cb2-58"></a>        model.add(Conv2D(<span class="dv">64</span>, (<span class="dv">3</span>, <span class="dv">3</span>), activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>))</span>
<span id="cb2-59"><a href="#cb2-59"></a>        model.add(MaxPooling2D(pool_size<span class="op">=</span>(<span class="dv">2</span>, <span class="dv">2</span>)))</span>
<span id="cb2-60"><a href="#cb2-60"></a>        model.add(Dropout(<span class="fl">0.25</span>))</span>
<span id="cb2-61"><a href="#cb2-61"></a>        model.add(Flatten())</span>
<span id="cb2-62"><a href="#cb2-62"></a>        model.add(Dense(<span class="dv">128</span>, activation<span class="op">=</span><span class="st">&#39;relu&#39;</span>))</span>
<span id="cb2-63"><a href="#cb2-63"></a>        model.add(Dropout(<span class="fl">0.5</span>))</span>
<span id="cb2-64"><a href="#cb2-64"></a>        model.add(Dense(num_classes, activation<span class="op">=</span><span class="st">&#39;softmax&#39;</span>))</span>
<span id="cb2-65"><a href="#cb2-65"></a>        </span>
<span id="cb2-66"><a href="#cb2-66"></a>        model.<span class="bu">compile</span>(loss<span class="op">=</span><span class="st">&quot;categorical_crossentropy&quot;</span>,</span>
<span id="cb2-67"><a href="#cb2-67"></a>                      optimizer<span class="op">=</span><span class="st">&quot;adam&quot;</span>,</span>
<span id="cb2-68"><a href="#cb2-68"></a>                      metrics<span class="op">=</span>[<span class="st">&#39;accuracy&#39;</span>])</span>
<span id="cb2-69"><a href="#cb2-69"></a>        </span>
<span id="cb2-70"><a href="#cb2-70"></a>        model.fit(x_train, y_train,</span>
<span id="cb2-71"><a href="#cb2-71"></a>                  batch_size<span class="op">=</span>batch_size,</span>
<span id="cb2-72"><a href="#cb2-72"></a>                  epochs<span class="op">=</span>epochs,</span>
<span id="cb2-73"><a href="#cb2-73"></a>                  verbose<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb2-74"><a href="#cb2-74"></a>                  validation_data<span class="op">=</span>(x_test, y_test))</span>
<span id="cb2-75"><a href="#cb2-75"></a>        score <span class="op">=</span> model.evaluate(x_test, y_test, verbose<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb2-76"><a href="#cb2-76"></a>        </span>
<span id="cb2-77"><a href="#cb2-77"></a>        model.save(<span class="va">self</span>.model_file)</span>
<span id="cb2-78"><a href="#cb2-78"></a></span>
<span id="cb2-79"><a href="#cb2-79"></a>        <span class="bu">print</span>(<span class="st">&#39;Test loss:&#39;</span>, score[<span class="dv">0</span>])</span>
<span id="cb2-80"><a href="#cb2-80"></a>        <span class="bu">print</span>(<span class="st">&#39;Test accuracy:&#39;</span>, score[<span class="dv">1</span>])</span>
<span id="cb2-81"><a href="#cb2-81"></a></span>
<span id="cb2-82"><a href="#cb2-82"></a></span>
<span id="cb2-83"><a href="#cb2-83"></a>mt <span class="op">=</span> ModelTrainer()</span>
<span id="cb2-84"><a href="#cb2-84"></a>mt.train()</span></code></pre></div>
<p>As we can see nothing very complicated here, it is just <a href="https://keras.io/examples/mnist_cnn/">the example from the keras documentation</a>. The only thing different is we are letting a few of our training variables and data be environment variables. That way, we can change those at build time, these will be defined in model.nix. Now we can really get into it.</p>
</div>
<div id="nix-expression-for-the-model" class="section level2">
<h2>nix expression for the model</h2>
<p>As usual, I will first display the code, and then walk through it line by line. Here is the file model.nix:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">{</span> <span class="ex">stdenv</span>, fetchurl, python37Packages</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co"># Number of epochs</span></span>
<span id="cb3-3"><a href="#cb3-3"></a>, <span class="ex">epochs</span> ? 10</span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co"># Selecting backend</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>, <span class="ex">cuda</span> ? true</span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="kw">}</span>:</span>
<span id="cb3-7"><a href="#cb3-7"></a></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="ex">with</span> stdenv.lib<span class="kw">;</span></span>
<span id="cb3-9"><a href="#cb3-9"></a></span>
<span id="cb3-10"><a href="#cb3-10"></a><span class="bu">let</span></span>
<span id="cb3-11"><a href="#cb3-11"></a></span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="ex">/*</span></span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="ex">Model</span> data!</span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="ex">*/</span></span>
<span id="cb3-15"><a href="#cb3-15"></a><span class="ex">data</span> = fetchurl {</span>
<span id="cb3-16"><a href="#cb3-16"></a>  <span class="ex">url</span>    =  https://s3.amazonaws.com/img-datasets/mnist.npz<span class="kw">;</span></span>
<span id="cb3-17"><a href="#cb3-17"></a>  <span class="ex">sha256</span> = <span class="st">&quot;1lbknqbzqs44qhnczv9a5bfdjl5qqgwgrgwgwk4609vm0b35l73k&quot;</span><span class="kw">;</span></span>
<span id="cb3-18"><a href="#cb3-18"></a>};</span>
<span id="cb3-19"><a href="#cb3-19"></a></span>
<span id="cb3-20"><a href="#cb3-20"></a><span class="kw">in</span> <span class="ex">stdenv.mkDerivation</span> rec {</span>
<span id="cb3-21"><a href="#cb3-21"></a>  <span class="ex">name</span>    = <span class="st">&quot;model-</span><span class="va">${version}</span><span class="st">&quot;</span><span class="kw">;</span></span>
<span id="cb3-22"><a href="#cb3-22"></a>  <span class="ex">version</span> = <span class="st">&quot;1&quot;</span><span class="kw">;</span></span>
<span id="cb3-23"><a href="#cb3-23"></a></span>
<span id="cb3-24"><a href="#cb3-24"></a>  <span class="ex">src</span>  =  ./py/trainer<span class="kw">;</span></span>
<span id="cb3-25"><a href="#cb3-25"></a></span>
<span id="cb3-26"><a href="#cb3-26"></a>  <span class="ex">/*</span> Model dependencies, adapted to the backed</span>
<span id="cb3-27"><a href="#cb3-27"></a>  <span class="ex">*/</span></span>
<span id="cb3-28"><a href="#cb3-28"></a>  <span class="ex">nativeBuildInputs</span> = with python37Packages<span class="kw">;</span><span class="bu"> [</span></span>
<span id="cb3-29"><a href="#cb3-29"></a>    python</span>
<span id="cb3-30"><a href="#cb3-30"></a>    h5py</span>
<span id="cb3-31"><a href="#cb3-31"></a>  ] ++ optionals (cuda == true) [</span>
<span id="cb3-32"><a href="#cb3-32"></a>    python37Packages.tensorflowWithCuda</span>
<span id="cb3-33"><a href="#cb3-33"></a>  ] ++ optionals (cuda == false) [</span>
<span id="cb3-34"><a href="#cb3-34"></a>    python37Packages.tensorflow</span>
<span id="cb3-35"><a href="#cb3-35"></a>  ];</span>
<span id="cb3-36"><a href="#cb3-36"></a></span>
<span id="cb3-37"><a href="#cb3-37"></a>  /* requiredSystemFeatures could be used to make</span>
<span id="cb3-38"><a href="#cb3-38"></a>     the model leverage nix distributed builds</span>
<span id="cb3-39"><a href="#cb3-39"></a></span>
<span id="cb3-40"><a href="#cb3-40"></a>       requiredSystemFeatures <span class="ot">=</span> [ <span class="st">&quot;big-parallel&quot;</span> <span class="st">&quot;cuda&quot;</span><span class="bu"> ]</span>;</span>
<span id="cb3-41"><a href="#cb3-41"></a>  <span class="ex">*/</span></span>
<span id="cb3-42"><a href="#cb3-42"></a></span>
<span id="cb3-43"><a href="#cb3-43"></a>  <span class="ex">/*</span> environment variables used in the train script</span>
<span id="cb3-44"><a href="#cb3-44"></a>  <span class="ex">*/</span></span>
<span id="cb3-45"><a href="#cb3-45"></a>  <span class="ex">EPOCHS</span> = epochs<span class="kw">;</span></span>
<span id="cb3-46"><a href="#cb3-46"></a>  <span class="ex">DATA</span> = data<span class="kw">;</span></span>
<span id="cb3-47"><a href="#cb3-47"></a></span>
<span id="cb3-48"><a href="#cb3-48"></a>  <span class="ex">unpackPhase</span> = <span class="st">&quot;:&quot;</span><span class="kw">;</span></span>
<span id="cb3-49"><a href="#cb3-49"></a></span>
<span id="cb3-50"><a href="#cb3-50"></a>  <span class="ex">/*</span> Training the model</span>
<span id="cb3-51"><a href="#cb3-51"></a>  <span class="ex">*/</span></span>
<span id="cb3-52"><a href="#cb3-52"></a>  <span class="ex">buildPhase</span> = <span class="st">&#39;&#39;</span></span>
<span id="cb3-53"><a href="#cb3-53"></a>    <span class="ex">python</span> <span class="va">$src</span>/train.py</span>
<span id="cb3-54"><a href="#cb3-54"></a>  <span class="st">&#39;&#39;</span>;</span>
<span id="cb3-55"><a href="#cb3-55"></a></span>
<span id="cb3-56"><a href="#cb3-56"></a>  <span class="ex">installPhase</span> = <span class="st">&#39;&#39;</span></span>
<span id="cb3-57"><a href="#cb3-57"></a>    <span class="fu">mkdir</span> -p <span class="va">$out</span></span>
<span id="cb3-58"><a href="#cb3-58"></a>    <span class="fu">cp</span> model.h5 <span class="va">$out</span>/</span>
<span id="cb3-59"><a href="#cb3-59"></a>  <span class="st">&#39;&#39;</span>;</span>
<span id="cb3-60"><a href="#cb3-60"></a>}</span></code></pre></div>
<p>So lets go through this line by line</p>
<div id="whats-in-those-brackets" class="section level3">
<h3>Whats in those brackets?</h3>
<p>This is our first time making a nix expression that doesnt do anything on its own. If you remember, in our previous example, we made an expression to include something that wasnt from nixpkgs in the same file as our build file. In this case, we are building something a bit bigger than a simple plotting package, so we will, for our mental health, want to make things modular. We can view this entire <code>model.nix</code> file as a function, where the stuff in the brackets at the top is <strong>arguments to the function</strong>. A question marks indicates a default option. So, word by word, the first argument is <code>stdenv</code>, which is nix’s standard set of build tools. Next is <code>fetchurl</code>, which allows us to get information from a website. We thin indicate which set of python packages we want (<code>python37Packages</code>). We are then specifying a default of 10 epochs (<code>epochs ? 10</code>) and that by default the model will use cuda (<code>cuda ? true</code>).</p>
</div>
<div id="getting-data" class="section level3">
<h3>Getting Data</h3>
<p>Next, we put everything under the scope of nix’s stdenv (build libs) (<code>with stdenv.lib</code>). This is pretty much just boilerplate, we need the build library to build things!! We then define the data variable. <code>fetchurl</code> is a function which requires two arguments in this case, it requires the url (unquoted), and a SHA hash to verify we are getting the right thing. We can either get this hash with <code>nix-prefetch-url</code> on the command line or we can just put in the wrong hash and copy and paste in the error output (not advised or particularly secure, but as a lazy master’s student I do this all the time).</p>
</div>
<div id="making-a-derivation" class="section level3">
<h3>Making a derivation</h3>
<p>We next call the <code>stdenv.mkDerivation</code> function, which takes in a recursive set (<code>rec</code>). The first thing we specify is the name of our derivation, which in this case is <code>model-${version}</code>. Nix will take the version we give later, and append it to the name. Then, when our model is built, it will appear in /nix/store as <code>longhash-model-${version}</code>, and the same in our binary cache. Next, and this is very important, we need to specify where the source code lives (<code>src</code>). Otherwise, Nix will not be able to build anything!! The source code for our model is in <code>src/trainer</code> (relative to where model.nix is).</p>
</div>
<div id="specifying-dependencies" class="section level3">
<h3>Specifying dependencies</h3>
<p>Here, instead of <code>buildInputs</code>, we are using <code>nativeBuildInputs</code>. I was wondering why this was the case (they did this in the example), so I did a <a href="https://matthewbauer.us/blog/beginners-guide-to-cross.html">bit of digging</a>. Basically, when <strong>building</strong> a package, you should use <code>nativeBuildInputs</code> for your build time dependencies, these are dependencies which will only be around when the package is being built. After the package is built, these will go away, while with <code>buildInputs</code>, they will not. Since we are basically just compiling a model to an h5 file (or in the case of standard machine learning, whatever filetype the output of <code>joblib.dump</code> is :) ), we do not need whatever version of tensorflow or python or anything to persist. We just need the resulting model file! So it is better to use <code>nativeBuildInputs</code>. Apparently (and I cannot claim to know much about this), this is a best practice for cross-compilation for OSes other than NixOS. Lets walk through our buildinputs now. First, we are putting the non optional ones under the scope of <code>python37Packages</code>. This means we are going to point everything in this <code>[]</code> list to the python37 section of nixpkgs, and look for them there. We have two things which are absolutely required for this: <code>h5py</code>, to save the model, and fairly obviously <code>python</code>. Next, we specify our optional inputs by appending to the list. These are build time dependencies that depend on variables we set, in our case, the usage of CUDA. If we are going to use CUDA( <code>++ optionals (cuda == true)</code>), we are going to require tensorflowWithCuda. Note that the optionals are outside the scope of <code>with python37Packages</code>, so we need to include that. If we arent going to use CUDA ( <code>++ optionals (cuda == false)</code> ), we use the normal tensorflow.</p>
</div>
<div id="specifying-our-environment-variables" class="section level3">
<h3>Specifying our environment variables</h3>
<p>We next need to specify the environment variables called by our source python code. We do this very simply, with equal signs…</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a><span class="va">EPOCHS=</span>epochs;</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="va">DATA=</span>data;</span></code></pre></div>
<p>If we wanted to specify a model file, we would do that here too</p>
</div>
<div id="build-and-install" class="section level3">
<h3>Build and install</h3>
<p>To build and install, we require 3 phases: the unpackPhase, the buildPhase, and the installPhase. The unpackPhase is to unpack any source code, which we do not need to do, so we set it to <code>":"</code>, which does nothing. We could alternative specify our own build phases, like this:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a><span class="ex">phases</span> = [<span class="st">&quot;buildPhase&quot;</span> <span class="st">&quot;installPhase&quot;</span>]<span class="kw">;</span></span></code></pre></div>
<p>And then completely leave out the unpack phase. In the buildPhase, we run our python code, and finally in the installPhase, we make an output directory, and put our resulting model in there!</p>
<p>If you got through this, congratulations! We are nearly set up!</p>
</div>
</div>
</div>
<div id="building-everything" class="section level1">
<h1>Building everything!</h1>
<p>We have finished the hard part, now we just have to put it all together. Lets go ahead and look at our default.nix file:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a><span class="ex">with</span> import <span class="op">&lt;</span>nixpkgs<span class="op">&gt;</span> {};</span>
<span id="cb6-2"><a href="#cb6-2"></a></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="ex">rec</span> {</span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="ex">/*</span> Model using default values (cuda true, 10 epochs)</span>
<span id="cb6-5"><a href="#cb6-5"></a>  <span class="ex">*/</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>  <span class="ex">model</span> = pkgs.callPackage ./model.nix {};</span>
<span id="cb6-7"><a href="#cb6-7"></a></span>
<span id="cb6-8"><a href="#cb6-8"></a>  <span class="co">#/* Model using tensorflow backend with 1 epoch</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>  <span class="co">#*/</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>  <span class="co">#simple-model = pkgs.callPackage ./model.nix {</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>  <span class="co">#  epochs = 1;</span></span>
<span id="cb6-12"><a href="#cb6-12"></a>  <span class="co">#};</span></span>
<span id="cb6-13"><a href="#cb6-13"></a></span>
<span id="cb6-14"><a href="#cb6-14"></a>  <span class="co">#/* Model using no CUDA backend with 3 epochs</span></span>
<span id="cb6-15"><a href="#cb6-15"></a>  <span class="co">#*/</span></span>
<span id="cb6-16"><a href="#cb6-16"></a>  <span class="ex">slow-model</span> = pkgs.callPackage ./model.nix {</span>
<span id="cb6-17"><a href="#cb6-17"></a>    <span class="ex">cuda</span> = False<span class="kw">;</span></span>
<span id="cb6-18"><a href="#cb6-18"></a>    <span class="ex">epochs</span>  = 20<span class="kw">;</span></span>
<span id="cb6-19"><a href="#cb6-19"></a>  };</span>
<span id="cb6-20"><a href="#cb6-20"></a>}</span></code></pre></div>
<p>And that is it! We are just going to use the callPackage function, which just runs everything. Note this structure, as if we had a ton of models we wanted built and saved, we could easily do that! Just with this exact same format. Note, currently, this is hardly reproducible. Another issue, if we run this code as is, we are going to be stuck using tf 1.15, which is not what we want. To fix this, we can actually pin nixpkgs. You can pin either with the fetchTarball or with fetchGit. We will do fetchGit, because I want a specific fork of nixpkgs which has tensorflow 2 specified:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a><span class="ex">with</span> import (    </span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="ex">builtins.fetchGit</span> {</span>
<span id="cb7-3"><a href="#cb7-3"></a>      <span class="ex">name</span> = <span class="st">&quot;nixos-tensorflow-2&quot;</span><span class="kw">;</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>      <span class="ex">url</span> = https://github.com/nixos/nixpkgs<span class="kw">;</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>      <span class="ex">ref</span> = <span class="st">&quot;d59b4d07045418bae85a9bdbfdb86d60bc1640bc&quot;</span><span class="kw">;</span>}) {};</span>
<span id="cb7-6"><a href="#cb7-6"></a></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="ex">rec</span> {</span>
<span id="cb7-8"><a href="#cb7-8"></a>  <span class="ex">/*</span> Model using default values (cuda true, 10 epochs)</span>
<span id="cb7-9"><a href="#cb7-9"></a>  <span class="ex">*/</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>  <span class="ex">model</span> = pkgs.callPackage ./model.nix {};</span>
<span id="cb7-11"><a href="#cb7-11"></a></span>
<span id="cb7-12"><a href="#cb7-12"></a>  <span class="co">#/* Model using tensorflow backend with 1 epoch</span></span>
<span id="cb7-13"><a href="#cb7-13"></a>  <span class="co">#*/</span></span>
<span id="cb7-14"><a href="#cb7-14"></a>  <span class="co">#simple-model = pkgs.callPackage ./model.nix {</span></span>
<span id="cb7-15"><a href="#cb7-15"></a>  <span class="co">#  epochs = 1;</span></span>
<span id="cb7-16"><a href="#cb7-16"></a>  <span class="co">#};</span></span>
<span id="cb7-17"><a href="#cb7-17"></a></span>
<span id="cb7-18"><a href="#cb7-18"></a>  <span class="co">#/* Model using no CUDA backend with 3 epochs</span></span>
<span id="cb7-19"><a href="#cb7-19"></a>  <span class="co">#*/</span></span>
<span id="cb7-20"><a href="#cb7-20"></a>  <span class="ex">slow-model</span> = pkgs.callPackage ./model.nix {</span>
<span id="cb7-21"><a href="#cb7-21"></a>    <span class="ex">cuda</span> = False<span class="kw">;</span></span>
<span id="cb7-22"><a href="#cb7-22"></a>    <span class="ex">epochs</span>  = 20<span class="kw">;</span></span>
<span id="cb7-23"><a href="#cb7-23"></a>  };</span>
<span id="cb7-24"><a href="#cb7-24"></a>}</span></code></pre></div>
<p>A very simple change, but this has tensorflow 2 intead of tensorflow 1.15, and will never change (as it is a specific git commit), but it will make our life easier for us and our collegues.</p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
